#!/usr/bin/env bash
apt update;
apt install -y wget git axel python3.12 python3-pip python3-dev python3-venv zsh sudo;
update-alternatives --install /usr/bin/python python /usr/bin/python3.12 2;
update-alternatives --set python /usr/bin/python3.12;
sh -c "";
mkdir -p /workspace;
DEBIAN_FRONTEND=noninteractive apt-get install openssh-server -y;
mkdir -p ~/.ssh;
chmod 700 ~/.ssh;
echo "" >> ~/.ssh/authorized_keys;
chmod 700 ~/.ssh/authorized_keys;
service ssh start;
wget https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2404/x86_64/cuda-keyring_1.1-1_all.deb\;
dpkg -i cuda-keyring_1.1-1_all.deb;
apt-get update;
apt-get install -y cuda-toolkit;
#wget https://bootstrap.pypa.io/get-pip.py -O get-pip.py;
#python3 get-pip.py;
#rm get-pip.py;
git clone https://github.com/Panchovix/stable-diffusion-webui-reForge.git /workspace/reforge;
cd /workspace/reforge;
python3 -m venv venv_reforge;
source venv_reforge/bin/activate;
pip3 install -r requirements.txt;
pip3 install -U --no-cache-dir jupyterlab jupyterlab_widgets ipykernel ipywidgets;
useradd -m -s /bin/zsh gsk;
echo "gsk:Shitfuck" | chpasswd;
usermod -aG sudo gsk;
su - gsk -c 'sh -c "$(wget -O- https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)"';
sed -i 's/#PasswordAuthentication yes/PasswordAuthentication yes/' /etc/ssh/sshd_config;
service sshd restart;
cd /workspace/reforge;
source venv_reforge/bin/activate && ./webui.sh --listen --port 7860 --user gsk --password Shitfuck &
cd /workspace;
deactivate;
git clone https://github.com/comfyanonymous/ComfyUI.git comfyui;
cd comfyui;
python3 -m venv venv_comfy;
source venv_comfy/bin/activate;
pip3 install -r requirements.txt;
python main.py --listen --port 8188 &
deactivate;
jupyter lab --allow-root --no-browser --port=8888 --ip=* --ServerApp.terminado_settings="{\"shell_command\":[\"/bin/bash\"]}" --ServerApp.token=$JUPYTER_PASSWORD --ServerApp.allow_origin=* --FileContentsManager.preferred_dir=/workspace;
sleep infinity;
